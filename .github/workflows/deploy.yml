name: XYLO-MD-DEPLOY
on:
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
          
      - name: Debug Environment
        run: |
          echo "=== ENVIRONMENT DEBUG ==="
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Working directory: $(pwd)"
          echo "Files in current directory:"
          ls -la
          echo "=== CONFIG & ENV CHECK ==="
          if [ -f ".env" ]; then echo "✓ .env file exists"; else echo "✗ .env file missing"; fi
          if [ -f "config.ts" ]; then echo "✓ config.ts exists"; else echo "✗ config.ts missing"; fi
          
      - name: Install Dependencies
        run: |
          echo "=== INSTALLING DEPENDENCIES ==="
          npm install --verbose
          echo "=== DEPENDENCY TREE ==="
          npm list --depth=0
          
      - name: Pre-run Checks
        run: |
          echo "=== PRE-RUN CHECKS ==="
          echo "Checking package.json scripts:"
          cat package.json | grep -A 10 '"scripts"'
          echo "=== CHECKING FOR MAIN FILES ==="
          if [ -f "index.ts" ]; then echo "✓ index.ts found"; else echo "✗ index.ts missing"; fi
          
      - name: Run Bot with Detailed Logging
        run: |
          echo "=== STARTING XYLO-MD BOT ==="
          echo "Timestamp: $(date)"
          
          run_bot() {
            echo ">>> Attempting to start bot..."
            npm start 2>&1 | while IFS= read -r line; do
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $line"
            done
            echo ">>> Bot process ended with exit code: $?"
          }
          
          timeout 18000 bash -c '
            attempt=1
            while true; do
              echo "=== ATTEMPT #$attempt ==="
              run_bot() {
                echo ">>> Starting bot attempt #$attempt at $(date)"
                npm start 2>&1 | while IFS= read -r line; do
                  echo "[$(date +"%H:%M:%S")] $line"
                done
                exit_code=$?
                return $exit_code
              }
              
              if run_bot; then
                echo "Bot exited normally, restarting in 5 seconds..."
              else
                echo "Bot crashed, analyzing resources and restarting in 10 seconds..."
                free -h
                df -h
              fi
              
              attempt=$((attempt + 1))
              sleep 10
            done
          ' || echo "Timeout reached after 5 hours"
          
      - name: Post-Run Analysis
        if: always()
        run: |
          echo "=== POST-RUN ANALYSIS ==="
          free -h
          
      - name: Re-Trigger Workflow
        if: always()
        run: |
          echo "=== AUTO-RESTART ==="
          sleep 30
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/dispatches \
            -d '{"ref":"${{ github.ref_name }}"}'
          echo "Restart triggered successfully"
